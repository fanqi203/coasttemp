<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SC USGS Stations: Stage + Discharge + Temperature</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 95vh; }
    .legend {
      background: white;
      padding: 6px 8px;
      font: 12px/14px Arial, Helvetica, sans-serif;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
    }
    .legend i {
      width: 12px;
      height: 12px;
      float: left;
      margin-right: 8px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <h3 style="margin: 6px; font-family: Arial, sans-serif;">SC USGS Stations with Water Level + Discharge + Temperature</h3>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Station data generated by sc_usgs_stations_wl_q_temp.js -->
  <script src="sc_usgs_stations_wl_q_temp.js"></script>
  <!-- Pre-fetched temperature cache built by build_temp_cache.py -->
  <script src="sc_usgs_temp_cache.js"></script>

  <script>
    if (typeof scStations === 'undefined') {
      alert('Station data (sc_usgs_stations_wl_q_temp.js) not found.');
    }

    var map = L.map('map').setView([33.8, -80.7], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var bounds = [];
    var tempCache = {};   // site_no -> { labels: [...], temps: [...] }
    var tempCharts = {};  // site_no -> Chart instance

    function renderTempChart(siteNo, canvas, statusDiv, labels, temps) {
      if (!canvas || !statusDiv) return;
      if (!labels.length) {
        statusDiv.textContent = 'No temperature data available from NWIS DV service.';
        return;
      }

      if (tempCharts[siteNo]) {
        tempCharts[siteNo].destroy();
      }

      var ctx = canvas.getContext('2d');
      tempCharts[siteNo] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Water temperature (\u00b0C)',
            data: temps,
            borderColor: '#d95f0e',
            backgroundColor: 'rgba(217,95,14,0.15)',
            pointRadius: 0,
            borderWidth: 1,
            fill: true
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { ticks: { maxTicksLimit: 6 } },
            y: { title: { display: true, text: '\u00b0C' } }
          }
        }
      });

      statusDiv.textContent = 'Daily mean temperature from ' + labels[0] +
        ' to ' + labels[labels.length - 1] + ' (NWIS DV).';
    }

    // Load temperature series for a station, prioritizing the static cache
    // and using the full temperature period (temp_begin to temp_end), not the
    // overlap with discharge or stage.
    function loadTempSeries(station, canvasId, statusId) {
      var siteNo = station.site_no;
      var canvas = document.getElementById(canvasId);
      var statusDiv = document.getElementById(statusId);
      if (!canvas || !statusDiv || !siteNo) return;

      // In-memory cache for this browser session
      if (tempCache[siteNo]) {
        var cached = tempCache[siteNo];
        renderTempChart(siteNo, canvas, statusDiv, cached.labels, cached.temps);
        return;
      }

      // First try to use the static, pre-fetched cache (no live network call)
      if (typeof staticTempCache !== 'undefined' && staticTempCache[siteNo]) {
        var pre = staticTempCache[siteNo] || {};
        var labelsFromStatic = pre.labels || [];
        var tempsFromStatic = pre.temps || [];
        tempCache[siteNo] = { labels: labelsFromStatic, temps: tempsFromStatic };
        renderTempChart(siteNo, canvas, statusDiv, labelsFromStatic, tempsFromStatic);
        return;
      }

      // If we already know there is no DV temperature data for this site,
      // do not attempt a live fetch; just surface a message.
      if (typeof staticTempNoDv !== 'undefined' &&
          Array.isArray(staticTempNoDv) &&
          staticTempNoDv.indexOf(siteNo) !== -1) {
        statusDiv.textContent =
          'No daily temperature (DV, 00010) data available from USGS for this station.';
        return;
      }

      // Use the full temperature period from the station metadata
      var start = station.temp_begin;
      var end = station.temp_end;
      if (!start || !end) {
        statusDiv.textContent =
          'No temperature date range available to request data for this station.';
        return;
      }

      statusDiv.textContent = 'Loading daily temperature (NWIS DV).....';

      var url = 'https://waterservices.usgs.gov/nwis/dv/?format=json&sites=' +
                encodeURIComponent(siteNo) +
                '&parameterCd=00010&startDT=' + encodeURIComponent(start) +
                '&endDT=' + encodeURIComponent(end);

      fetch(url)
        .then(function (resp) {
          if (!resp.ok) {
            // Surface HTTP status so user can see what failed (e.g., 403, 500)
            statusDiv.textContent = 'HTTP ' + resp.status + ' while loading temperature data.';
            throw new Error('HTTP ' + resp.status);
          }
          return resp.json();
        })
        .then(function (data) {
          try {
            var tsArr = (data && data.value && data.value.timeSeries) || [];
            if (!tsArr.length || !tsArr[0].values || !tsArr[0].values.length) {
              statusDiv.textContent = 'No daily temperature data returned for this site.';
              return;
            }
            var vals = tsArr[0].values[0].value || [];
            var labels = [];
            var temps = [];
            vals.forEach(function (v) {
              if (!v || v.value === undefined || v.value === null || v.value === '') return;
              var dt = v.dateTime || '';
              labels.push(dt.substring(0, 10));
              temps.push(parseFloat(v.value));
            });

            tempCache[siteNo] = { labels: labels, temps: temps };
            renderTempChart(siteNo, canvas, statusDiv, labels, temps);
          } catch (e) {
            console.error(e);
            statusDiv.textContent = 'Error parsing temperature data.';
          }
        })
        .catch(function (err) {
          console.error(err);
          var msg = (err && err.message) ? err.message : String(err);
          // Show a concise but informative error message in the popup
          statusDiv.textContent = 'Error loading temperature data: ' + msg;
        });
    }

    // Plot only stations that have temperature data and coordinates
    (scStations || []).forEach(function (s) {
      // Only plot stations that have some temperature record and coordinates
      if (!s.temp_begin || !s.temp_end) return;
      if (s.lat === null || s.lon === null) return;

      var color = s.has_salinity === 'Y' ? '#e6550d' : '#3182bd';
      var marker = L.circleMarker([s.lat, s.lon], {
        radius: 5,
        color: color,
        fillColor: color,
        fillOpacity: 0.85,
        weight: 1
      });

      var tooltipText = (s.site_no || '') + ' - ' + (s.station_name || '');
      marker.bindTooltip(tooltipText, { sticky: true });

      function fmtRange(b, e) {
        if (!b && !e) return 'n/a';
        if (b && !e) return b + ' - ?';
        if (!b && e) return '? - ' + e;
        return b + ' - ' + e;
      }

      var canvasId = 'tempChart-' + (s.site_no || '');
      var statusId = 'tempStatus-' + (s.site_no || '');

      var popupHtml = '' +
        '<b>' + (s.station_name || '') + '</b><br/>' +
        'USGS ' + (s.site_no || '') + '<br/><br/>' +
        '<b>Temperature (00010):</b> ' + fmtRange(s.temp_begin, s.temp_end) + '<br/>' +
        '<b>Discharge (00060):</b> ' + fmtRange(s.discharge_begin, s.discharge_end) + '<br/>' +
        '<b>Stage (00065):</b> ' + fmtRange(s.stage_begin, s.stage_end) + '<br/>' +
        '<b>Salinity/SC (00480):</b> ' + fmtRange(s.salinity_begin, s.salinity_end) + '<br/>' +
        '<b>Overlap (all 3):</b> ' + fmtRange(s.overlap_begin_all3, s.overlap_end_all3) + '<br/>' +
        '<div style="margin-top:6px; max-width:360px;">' +
          '<div id="' + statusId + '" style="font-size:11px;color:#555;">Click marker to load daily temperature time series.....</div>' +
          '<div style="height:180px;">' +
            '<canvas id="' + canvasId + '" width="340" height="160"></canvas>' +
          '</div>' +
        '</div>';

      marker.bindPopup(popupHtml);

      marker.on('popupopen', function () {
        loadTempSeries(s, canvasId, statusId);
      });
      marker.addTo(map);
      bounds.push([s.lat, s.lon]);
    });

    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [20, 20] });
    }
  </script>
</body>
</html>
